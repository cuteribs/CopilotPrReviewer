{
	"nodes":[
		{"id":"title","type":"text","x":300,"y":-100,"width":800,"height":60,"color":"4","text":"# C4 Code Diagram — CopilotPrReviewer Internal Structure"},
		{"id":"program","type":"text","x":0,"y":0,"width":500,"height":320,"color":"4","text":"## Program.cs (CLI Entry Point)\n```\nprUrlArg, patOption, authTypeOption,\nmodelOption, timeoutOption, githubTokenOption,\nguidelinesPathOption, maxParallelOption, noCommentsOption\n```\n**Flow:**\n1. Parse CLI args via `System.CommandLine`\n2. Set env vars from `--pat`, `--github-token`\n3. Build `IConfiguration` (appsettings → env → CLI)\n4. Register DI services\n5. `orchestrator.RunAsync(prUrl)`\n6. `reporter.PrintSummary(summary)`"},
		{"id":"orchestrator-code","type":"text","x":550,"y":0,"width":500,"height":360,"color":"4","text":"## ReviewOrchestrator\n**Dependencies:** AzureDevOpsClient, BatchBuilder, CopilotReviewService, CopilotSettings, ReviewSettings\n\n**`RunAsync(prUrl)`:**\n1. `_adoClient.ParsePrUrl(prUrl)` → PrInfo\n2. `_adoClient.GetPrDetailsAsync(prInfo)` → PullRequest\n3. `_adoClient.FetchPrChangesAsync(prInfo, pr)` → FilePatch[]\n4. `_batchBuilder.CreateBatches(patches)` → BatchResult\n5. Parallel `_copilotService.ReviewBatchAsync(batch)` with SemaphoreSlim\n6. `PostFindingsAsync(prInfo, findings)` → thread comments\n7. Return `ReviewSummary`\n\n**`PostFindingsAsync(prInfo, findings)`:**\nFormat comment text + suggestion block, call `PostPrCommentAsync`"},
		{"id":"ado-code","type":"text","x":0,"y":380,"width":500,"height":460,"color":"6","text":"## AzureDevOpsClient\n**Dependencies:** HttpClient, AzureDevOpsSettings, IAuthenticator\n\n**Public Methods:**\n- `ParsePrUrl(url)` → PrInfo (regex: dev.azure.com + visualstudio.com)\n- `GetPrDetailsAsync(prInfo)` → PullRequest (validates active + no conflicts)\n- `FetchPrChangesAsync(prInfo, pr)` → FilePatch[] (commit diffs → per-file blob fetch → unified diff)\n- `PostPrCommentAsync(prInfo, opts)` → create PR thread\n\n**Private Helpers:**\n- `GetBaseUrl(prInfo)` → API base URL\n- `ConfigureAuthHeadersAsync(req)` → Basic/Bearer auth\n- `SendRequestAsync<T>(url, method, body)` → typed HTTP call\n- `GetBlobContentAsync(url)` → file content as text\n- `GetFilePatchAsync(change, baseUrl)` → FilePatch\n- `GenerateUnifiedDiffWithStats(file, old, new)` → unified diff via DiffPlex InlineDiffBuilder\n- `WriteHunk(sb, start, oldCount, newCount, lines)`\n\n**Regex:** DevAzureRegex, VisualStudioRegex (source-generated)"},
		{"id":"auth-code","type":"text","x":0,"y":880,"width":500,"height":280,"color":"3","text":"## Auth Module\n**IAuthenticator** (interface)\n- `GetAuthOptionsAsync()` → AuthOptions { Type, Token }\n\n**OAuthAuthenticator**\n- MSAL PublicClientApplication\n- Silent → Interactive fallback\n- Cross-platform browser opening\n\n**PatAuthenticator**\n- Simple token wrapper from AZURE_DEVOPS_PAT\n\n**AuthenticatorFactory** (static)\n- `CreateAuthenticator(authType?)` → pat | oauth | auto-detect"},
		{"id":"batch-code","type":"text","x":550,"y":400,"width":500,"height":340,"color":"1","text":"## BatchBuilder + Helpers\n**Dependencies:** TechStackClassifier, FileExclusionFilter, TokenCounter, CopilotSettings\n\n**`CreateBatches(FilePatch[])`:**\n1. For each file: classify → filter → group by TechStack\n2. Sort files by size (ascending) within each stack\n3. Bin-pack files into batches within `availableTokens` budget\n4. Return `BatchResult { Batches, ExcludedFiles }`\n\n**TechStackClassifier.Classify(path)**\nDictionary<ext, TechStack>: .cs→Dotnet, .tsx→Frontend, .py→Python, .json→Config\n\n**FileExclusionFilter.ShouldExclude(path)**\nExact: package-lock.json, yarn.lock…\nSuffix: .min.js, .d.ts, .g.cs…\n\n**TokenCounter.CountTokens(text)**\nSharpToken `cl100k_base` encoding → token count"},
		{"id":"copilot-code","type":"text","x":550,"y":780,"width":500,"height":380,"color":"2","text":"## CopilotReviewService + FindingParser\n**Dependencies:** CopilotSettings, GuidelineProvider\n\n**`ReviewBatchAsync(batch)`:**\n1. `BuildReviewPrompt(batch)` → full prompt string\n2. Create `CopilotClient` + `CreateSessionAsync(model)`\n3. Register event handler (AssistantMessage → append, SessionIdle → complete, Error → throw)\n4. `SendAndWaitAsync(prompt, timeout)`\n5. `FindingParser.Parse(response)` → List<ReviewFinding>\n\n**`BuildReviewPrompt(batch)`:**\n- System instruction + guidelines + file contents + diffs + output format\n\n**FindingParser.Parse(response):**\n- `ExtractJson(text)` → find JSON array in ```json``` block, bare block, or raw\n- Deserialize to `List<ReviewFinding>`\n\n**GuidelineProvider.GetGuidelines(stack):**\nExternal path → embedded resource fallback, with cache"},
		{"id":"models-code","type":"text","x":1100,"y":0,"width":400,"height":520,"color":"6","text":"## Models\n\n**PrInfo** — Organization, Project, Repository, PullRequestId\n\n**PullRequest** — Id, Title, Description, Status, MergeStatus, Source/TargetRefName, CreatedBy\n\n**FilePatch** — FilePath, SourceContent, NewContent, Patch, ChangeType, LinesAdded/Deleted\n\n**CommitDiffs** — Changes: GitChange[] → GitItem { ObjectId, Path, Url }\n\n**ReviewBatch** — BatchNumber, TechStack, TotalTokens, Files: Dict<path, BatchFile{Content, Diff}>\n\n**ReviewFinding** — FilePath, LineNumber, Severity, Description, Suggestion\n\n**ReviewSummary** — PrUrl, PrTitle, TotalFiles, ReviewedFiles, ExcludedFiles, TotalBatches, Findings, CommentsPosted, Duration\n\n**PrThread** — Comments[], ThreadContext { FilePath, RightFileStart/End }\n\n**AuthOptions** — Type, Token\n\n**Enums:** TechStack (Dotnet|Frontend|Python|Config), Severity (Critical|Major|Minor)"},
		{"id":"config-code","type":"text","x":1100,"y":560,"width":400,"height":200,"color":"6","text":"## Configuration\n\n**AzureDevOpsSettings** (\"AzureDevOps\")\n- AuthType?, BaseUrl = dev.azure.com\n\n**CopilotSettings** (\"Copilot\")\n- Model, MaxTokensPerBatch, OverheadTokens, MaxParallelBatches, TimeoutSeconds\n\n**ReviewSettings** (\"Review\")\n- GuidelinesPath?, PostComments = true\n\n**Sources:** appsettings.json → env vars (COPILOT_PR_REVIEWER_) → CLI args"},
		{"id":"resources-code","type":"text","x":1100,"y":800,"width":400,"height":140,"color":"3","text":"## Embedded Resources\n- `dotnet-guidelines.md` — C# / .NET best practices\n- `frontend-guidelines.md` — JS/TS/React best practices\n- `python-guidelines.md` — Python best practices\n- `review-output-format.md` — JSON array output schema"},
		{"id":"reporter-code","type":"text","x":1100,"y":980,"width":400,"height":140,"color":"3","text":"## ConsoleReporter\n**`PrintSummary(ReviewSummary)`:**\n- Overview table (URL, title, files, batches, duration)\n- Severity breakdown table (Critical, Major, Minor counts)\n- Top 10 Critical/Major findings table\n- Spectre.Console rich formatting"}
	],
	"edges":[
		{"id":"c1","fromNode":"program","fromSide":"right","toNode":"orchestrator-code","toSide":"left","label":"RunAsync → PrintSummary"},
		{"id":"c2","fromNode":"orchestrator-code","fromSide":"bottom","toNode":"ado-code","toSide":"top","label":"parse + fetch + post"},
		{"id":"c3","fromNode":"orchestrator-code","fromSide":"bottom","toNode":"batch-code","toSide":"top","label":"CreateBatches"},
		{"id":"c4","fromNode":"orchestrator-code","fromSide":"bottom","toNode":"copilot-code","toSide":"top","label":"ReviewBatchAsync (parallel)"},
		{"id":"c5","fromNode":"ado-code","fromSide":"bottom","toNode":"auth-code","toSide":"top","label":"IAuthenticator"},
		{"id":"c6","fromNode":"orchestrator-code","fromSide":"right","toNode":"models-code","toSide":"left","label":"uses"},
		{"id":"c7","fromNode":"program","fromSide":"right","toNode":"config-code","toSide":"left","label":"binds"}
	]
}